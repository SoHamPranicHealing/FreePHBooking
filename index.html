<!DOCTYPE html>
<html lang="el">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Κλείστε μία δωρεάν θεραπεία Pranic Healing</title>
    <script crossorigin src="https://unpkg.com/react@18/umd/react.production.min.js"></script>
    <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.production.min.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
</head>
<body>
    <div id="root"></div>
    
    <script type="text/babel">
        const { useState, useEffect } = React;
        
        // ⚠️ REPLACE THIS WITH YOUR GOOGLE SHEETS WEB APP URL ⚠️
        const GOOGLE_SHEETS_URL = "https://script.google.com/macros/s/AKfycbztLF-sgkoIDR3enbCFH-LeaRXyVxDmKllaIKX73Ssi4rlOVAYOyYSBTzAEY80k5vgMfg/exec";
        
        // Admin password - CHANGE THIS to your own secure password
        const ADMIN_PASSWORD = "1123581321";
        
        function AppointmentBooking() {
          // Form state
          const [formData, setFormData] = useState({
            firstName: '',
            lastName: '',
            email: '',
            phone: ''
          });
          const [selectedTime, setSelectedTime] = useState('');
          const [gdprAccepted, setGdprAccepted] = useState(false);
          const [submitted, setSubmitted] = useState(false);
          
          // Admin state
          const [reservations, setReservations] = useState([]);
          const [showAdmin, setShowAdmin] = useState(false);
          const [isAdminAuthenticated, setIsAdminAuthenticated] = useState(false);
          const [adminDate, setAdminDate] = useState('');
          const [timeSlots, setTimeSlots] = useState({});
          const [newSlotTime, setNewSlotTime] = useState('');
          const [gdprText, setGdprText] = useState('');
          const [settingsLoaded, setSettingsLoaded] = useState(false);
          
          // Loading state
          const [loading, setLoading] = useState(false);
          const [savingSettings, setSavingSettings] = useState(false);

          const minDate = new Date().toISOString().split('T')[0];

          // Helper functions to convert between yyyy-MM-dd and dd/MM/yyyy
          const toDisplayFormat = (isoDate) => {
            if (!isoDate) return '';
            const [year, month, day] = isoDate.split('-');
            return `${day}/${month}/${year}`;
          };

          const toISOFormat = (displayDate) => {
            if (!displayDate) return '';
            const [day, month, year] = displayDate.split('/');
            return `${year}-${month}-${day}`;
          };

          // Load bookings from Google Sheets
          const loadBookings = async () => {
            if (GOOGLE_SHEETS_URL === "YOUR_WEB_APP_URL_HERE") {
              console.log("Please add your Google Sheets URL");
              return;
            }
            
            try {
              setLoading(true);
              const response = await fetch(GOOGLE_SHEETS_URL + '?action=getBookings&t=' + Date.now());
              const data = await response.json();
              if (data.bookings) {
                console.log('Loaded bookings:', data.bookings);
                setReservations(data.bookings);
              }
            } catch (error) {
              console.error('Error loading bookings:', error);
            } finally {
              setLoading(false);
            }
          };

          // Load settings from Google Sheets
          const loadSettings = async () => {
            if (GOOGLE_SHEETS_URL === "YOUR_WEB_APP_URL_HERE") {
              // Set defaults if no URL configured
              setAdminDate('15/01/2025'); // FIXED DATE
              setTimeSlots({'09:00': 2, '10:00': 2, '11:00': 2, '12:00': 2, '13:00': 2, '14:00': 2, '15:00': 2, '16:00': 1, '17:00': 1, '18:00': 1, '19:00': 1, '20:00': 2, '21:00': 2});
              setGdprText('Δηλώνω την σαφή και ανεπιφύλακτη συγκατάθεση μου στην Ειρήνη Τουρλεντέ του Παναγιώτη (So Ham - Yoga & Pranic Healing) για τη συλλογή, τήρηση κι επεξεργασία των ανωτέρω δεδομένων μου, για την προς εμένα αποστολή ενημερωτικού mail με επιλεγμένες εκδηλώσεις και διδακτικά σεμινάρια του. Δηλώνω, επίσης, ότι ενημερώθηκα για την ύπαρξη δικαιώματος ανάκλησης της ως άνω χορηγηθείσας συγκατάθεσής μου ή διόρθωσης αυτών με την αποστολή αντίστοιχου mail στην ηλεκτρονική διεύθυνση sohamgreece@gmail.com Τα ως άνω δεδομένα θα διατηρηθούν μέχρι την ρητή ανάκληση της συγκατάθεσης.Υπάρχει δικαίωμα υποβολής καταγγελίας στην αρμόδια εποπτική αρχή. Υπεύθυνος επεξεργασίας: Ειρήνη Τουρλεντέ του Παναγιώτη (So Ham - Yoga & Pranic Healing).');
              setSettingsLoaded(true);
              return;
            }
            
            try {
              console.log('Loading settings from Google Sheets...');
              const response = await fetch(GOOGLE_SHEETS_URL + '?action=getSettings&t=' + Date.now());
              const data = await response.json();
              console.log('Settings received from Sheets:', data);
              
              // Only update if we received valid data
              if (data && Object.keys(data).length > 0) {
                // ALWAYS USE FIXED DATE - ignore what's in sheets
                setAdminDate('15/01/2025');
                
                if (data.timeSlots) {
                  console.log('Setting timeSlots to:', data.timeSlots);
                  setTimeSlots(data.timeSlots);
                }
                if (data.gdprText) {
                  console.log('Setting gdprText to:', data.gdprText);
                  setGdprText(data.gdprText);
                }
              } else {
                // No settings in sheet, use defaults
                console.log('No settings in sheet, using defaults');
                setAdminDate('15/01/2025');
                setTimeSlots({'09:00': 3, '09:30': 3, '10:00': 3, '14:00': 2, '14:30': 2});
                setGdprText('Αποδέχομαι τους όρους GDPR');
              }
              setSettingsLoaded(true);
            } catch (error) {
              console.error('Error loading settings:', error);
              // Use defaults on error
              setAdminDate('15/01/2025');
              setTimeSlots({'09:00': 3, '09:30': 3, '10:00': 3, '14:00': 2, '14:30': 2});
              setGdprText('Αποδέχομαι τους όρους GDPR');
              setSettingsLoaded(true);
            }
          };

          // Save settings to Google Sheets - only when button clicked
          const saveSettings = async () => {
            if (GOOGLE_SHEETS_URL === "YOUR_WEB_APP_URL_HERE") {
              alert("Please configure Google Sheets URL");
              return;
            }
            
            try {
              setSavingSettings(true);
              await fetch(GOOGLE_SHEETS_URL, {
                method: 'POST',
                mode: 'no-cors',
                headers: {
                  'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                  action: 'saveSettings',
                  adminDate: '15/01/2025', // FIXED DATE - always save this
                  timeSlots: timeSlots,
                  gdprText: gdprText
                })
              });
              alert('Settings saved successfully!');
            } catch (error) {
              console.error('Error saving settings:', error);
              alert('Error saving settings');
            } finally {
              setSavingSettings(false);
            }
          };

          // Load settings and bookings on mount - ONLY ONCE
          useEffect(() => {
            const init = async () => {
              await loadSettings();
              await loadBookings();
            };
            init();
          }, []);

          // REMOVED auto-refresh - only manual refresh via button
          // No more automatic refreshing that causes the form to reload

          const getAvailableSlots = () => {
            const available = [];
            console.log('=== CALCULATING AVAILABLE SLOTS ===');
            console.log('Admin Date:', adminDate);
            console.log('Time Slots:', timeSlots);
            console.log('All Reservations:', reservations);
            
            // Filter reservations for this specific date
            const reservationsForDate = reservations.filter(res => {
              const match = res.date === adminDate;
              console.log(`Reservation: ${res.firstName} ${res.lastName} - Date: "${res.date}" vs Admin: "${adminDate}" - Match: ${match}`);
              return match;
            });
            
            console.log('Reservations for this date:', reservationsForDate);
            
            Object.keys(timeSlots).forEach(time => {
              const bookedCount = reservationsForDate.filter(res => res.time === time).length;
              const capacity = timeSlots[time];
              const available_spaces = capacity - bookedCount;
              
              console.log(`Time ${time}: Capacity=${capacity}, Booked=${bookedCount}, Available=${available_spaces}`);
              
              if (bookedCount < capacity) {
                available.push({ time, booked: bookedCount, capacity });
              } else {
                console.log(`  -> FULLY BOOKED, NOT SHOWING`);
              }
            });
            
            console.log('Final available slots:', available);
            console.log('=== END CALCULATION ===');
            return available.sort((a, b) => a.time.localeCompare(b.time));
          };

          const handleSubmit = async () => {
            const fullName = `${formData.firstName} ${formData.lastName}`.trim();
            
            if (adminDate && selectedTime && fullName && formData.email && gdprAccepted) {
              if (GOOGLE_SHEETS_URL === "YOUR_WEB_APP_URL_HERE") {
                alert("Admin needs to configure Google Sheets URL");
                return;
              }
              
              try {
                setLoading(true);
                
                // Send to Google Sheets with dd/MM/yyyy format
                await fetch(GOOGLE_SHEETS_URL, {
                  method: 'POST',
                  mode: 'no-cors',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    action: 'addBooking',
                    firstName: formData.firstName,
                    lastName: formData.lastName,
                    email: formData.email,
                    phone: formData.phone,
                    date: adminDate, // Send as dd/MM/yyyy
                    time: selectedTime
                  })
                });

                setSubmitted(true);
                
                // Reload bookings after a short delay
                setTimeout(() => {
                  loadBookings();
                  setFormData({ firstName: '', lastName: '', email: '', phone: '' });
                  setSelectedTime('');
                  setGdprAccepted(false);
                  setSubmitted(false);
                }, 2000);
                
              } catch (error) {
                console.error('Error submitting booking:', error);
                alert('Error submitting booking. Please try again.');
              } finally {
                setLoading(false);
              }
            }
          };

          const handleDeleteReservation = async (id) => {
            if (confirm('Are you sure you want to delete this booking?')) {
              try {
                setLoading(true);
                
                await fetch(GOOGLE_SHEETS_URL, {
                  method: 'POST',
                  mode: 'no-cors',
                  headers: {
                    'Content-Type': 'application/json',
                  },
                  body: JSON.stringify({
                    action: 'deleteBooking',
                    rowIndex: id - 1
                  })
                });

                setTimeout(() => {
                  loadBookings();
                }, 1000);
                
              } catch (error) {
                console.error('Error deleting booking:', error);
                alert('Error deleting booking. Please try again.');
              } finally {
                setLoading(false);
              }
            }
          };

          const handleAddTimeSlot = () => {
            if (newSlotTime && !timeSlots[newSlotTime]) {
              setTimeSlots({
                ...timeSlots,
                [newSlotTime]: 3
              });
              setNewSlotTime('');
            }
          };

          const handleRemoveTimeSlot = (time) => {
            const { [time]: _, ...rest } = timeSlots;
            setTimeSlots(rest);
          };

          const handleUpdateCapacity = (time, change) => {
            const newCapacity = Math.max(1, timeSlots[time] + change);
            setTimeSlots({
              ...timeSlots,
              [time]: newCapacity
            });
          };

          const handleAdminToggle = () => {
            if (!showAdmin && !isAdminAuthenticated) {
              const password = prompt("Enter admin password:");
              if (password === ADMIN_PASSWORD) {
                setIsAdminAuthenticated(true);
                setShowAdmin(true);
              } else {
                alert("Incorrect password!");
              }
            } else {
              setShowAdmin(!showAdmin);
            }
          };

          const availableSlots = getAvailableSlots();

          return (
            <div className="min-h-screen bg-gradient-to-br from-blue-50 to-indigo-100 p-4">
              <div className="max-w-7xl mx-auto mb-4 flex justify-end">
                <button
                  onClick={handleAdminToggle}
                  className="text-xs px-3 py-1 bg-gray-300 hover:bg-gray-400 text-gray-700 rounded transition-colors"
                >
                  {showAdmin ? 'Hide Admin' : 'Admin View'}
                </button>
              </div>

              {loading && (
                <div className="max-w-7xl mx-auto mb-4 text-center">
                  <p className="text-indigo-600 font-semibold">Loading...</p>
                </div>
              )}

              <div className="max-w-7xl mx-auto">
                <div className="grid grid-cols-1 lg:grid-cols-3 gap-6">
                  <div className={showAdmin ? 'lg:col-span-2' : ''}>
                    <div className="bg-white rounded-lg shadow-lg p-8">
                      <h1 className="text-3xl font-bold text-gray-800 mb-2">Κλείστε μία δωρεάν θεραπεία Pranic Healing</h1>
                      <p className="text-gray-600 mb-6"> </p>

                      {submitted ? (
                        <div className="bg-green-50 border border-green-200 rounded-lg p-4 text-center">
                          <p className="text-green-800 font-semibold">✓ Η κράτηση έγινε!</p>
                          <p className="text-green-700 text-sm mt-2">
                            Ευχαριστούμε
                          </p>
                        </div>
                      ) : (
                        <div className="space-y-5">
                          <div className="grid grid-cols-2 gap-3">
                            <div>
                              <label className="flex items-center text-sm font-semibold text-gray-700 mb-2">
                                Όνομα
                              </label>
                              <input
                                type="text"
                                value={formData.firstName}
                                onChange={(e) => setFormData({...formData, firstName: e.target.value})}
                                placeholder="Όνομα"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                              />
                            </div>
                            <div>
                              <label className="text-sm font-semibold text-gray-700 mb-2 block">
                                Επώνυμο
                              </label>
                              <input
                                type="text"
                                value={formData.lastName}
                                onChange={(e) => setFormData({...formData, lastName: e.target.value})}
                                placeholder="Επώνυμο"
                                className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                              />
                            </div>
                          </div>

                          <div>
                            <label className="flex items-center text-sm font-semibold text-gray-700 mb-2">
                              Email
                            </label>
                            <input
                              type="email"
                              value={formData.email}
                              onChange={(e) => setFormData({...formData, email: e.target.value})}
                              placeholder="john@example.com"
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                            />
                          </div>

                          <div>
                            <label className="flex items-center text-sm font-semibold text-gray-700 mb-2">
                              Τηλεφωνο
                            </label>
                            <input
                              type="tel"
                              value={formData.phone}
                              onChange={(e) => setFormData({...formData, phone: e.target.value})}
                              placeholder="+30 123 456 7890"
                              className="w-full px-4 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                            />
                          </div>

                          <div>
                            <label className="flex items-center text-sm font-semibold text-gray-700 mb-2">
                              Ημερομηνία
                            </label>
                            <div className="bg-gray-100 px-4 py-2 rounded-lg text-gray-700 font-medium">
                              {adminDate || 'No date set'}
                            </div>
                          </div>

                          <div>
                            <label className="flex items-center text-sm font-semibold text-gray-700 mb-2">
                              Ώρα
                            </label>
                            {adminDate && Object.keys(timeSlots).length > 0 ? (
                              availableSlots.length > 0 ? (
                                <div className="grid grid-cols-2 gap-2">
                                  {availableSlots.map(slot => (
                                    <button
                                      key={slot.time}
                                      onClick={() => setSelectedTime(slot.time)}
                                      className={`py-3 px-3 rounded-lg font-medium transition-all text-sm ${
                                        selectedTime === slot.time
                                          ? 'bg-indigo-600 text-white ring-2 ring-indigo-400'
                                          : 'bg-gray-100 text-gray-700 hover:bg-gray-200'
                                      }`}
                                    >
                                      {slot.time}
                                    </button>
                                  ))}
                                </div>
                              ) : (
                                <p className="text-red-600 text-sm">Δεν υπάρχουν διαθέσιμες ώρες</p>
                              )
                            ) : (
                              <p className="text-gray-500 text-sm">Δεν υπάρχουν διαθέσιμες ώρες</p>
                            )}
                          </div>

                          <div className="flex items-start gap-3 p-3 bg-gray-50 rounded-lg">
                            <input
                              type="checkbox"
                              id="gdpr"
                              checked={gdprAccepted}
                              onChange={(e) => setGdprAccepted(e.target.checked)}
                              className="w-4 h-4 mt-1 cursor-pointer"
                            />
                            <label htmlFor="gdpr" className="text-xs text-gray-700 cursor-pointer">
                              {gdprText}
                            </label>
                          </div>

                          <button
                            onClick={handleSubmit}
                            disabled={!adminDate || !selectedTime || !formData.firstName || !formData.lastName || !formData.email || !gdprAccepted || loading}
                            className="w-full bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white font-semibold py-3 rounded-lg transition-colors duration-200"
                          >
                            {loading ? 'Επεξεργασία...' : 'Επιβεβαίωση Κράτησης'}
                          </button>
                        </div>
                      )}
                    </div>
                  </div>

                  {showAdmin && (
                    <div className="lg:col-span-1">
                      <div className="bg-white rounded-lg shadow-lg p-6">
                        <h2 className="text-2xl font-bold text-gray-800 mb-4">Admin Panel</h2>

                        <div className="mb-6 pb-6 border-b border-gray-200">
                          <label className="text-sm font-semibold text-gray-700 mb-2 block">
                            Booking Date (Fixed)
                          </label>
                          <div className="bg-gray-100 px-3 py-2 rounded-lg text-gray-700 font-medium text-sm">
                            15/01/2025
                          </div>
                          <p className="text-xs text-gray-500 mt-1">Date is fixed and cannot be changed</p>
                        </div>

                        <div className="mb-6 pb-6 border-b border-gray-200">
                          <label className="text-sm font-semibold text-gray-700 mb-2 block">
                            GDPR Text
                          </label>
                          <textarea
                            value={gdprText}
                            onChange={(e) => setGdprText(e.target.value)}
                            className="w-full px-3 py-2 border border-gray-300 rounded-lg focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none text-xs"
                            rows="3"
                            placeholder="Enter GDPR terms here..."
                          />
                        </div>

                        <div className="mb-6 pb-6 border-b border-gray-200">
                          <h3 className="font-semibold text-gray-800 mb-3 text-sm">Time Slots</h3>
                          <div className="space-y-2 mb-3 max-h-40 overflow-y-auto">
                            {Object.keys(timeSlots)
                              .sort()
                              .map(time => (
                                <div key={time} className="flex items-center justify-between bg-gray-50 p-2 rounded">
                                  <span className="text-sm font-medium text-gray-700">{time}</span>
                                  <div className="flex items-center gap-2">
                                    <button
                                      onClick={() => handleUpdateCapacity(time, -1)}
                                      className="p-1 bg-red-100 hover:bg-red-200 text-red-600 rounded"
                                    >
                                      -
                                    </button>
                                    <span className="text-sm font-semibold text-gray-700 w-6 text-center">
                                      {timeSlots[time]}
                                    </span>
                                    <button
                                      onClick={() => handleUpdateCapacity(time, 1)}
                                      className="p-1 bg-green-100 hover:bg-green-200 text-green-600 rounded"
                                    >
                                      +
                                    </button>
                                    <button
                                      onClick={() => handleRemoveTimeSlot(time)}
                                      className="p-1 bg-gray-200 hover:bg-gray-300 text-gray-600 rounded ml-1"
                                    >
                                      ×
                                    </button>
                                  </div>
                                </div>
                              ))}
                          </div>

                          <div className="flex gap-2 mt-3">
                            <input
                              type="time"
                              value={newSlotTime}
                              onChange={(e) => setNewSlotTime(e.target.value)}
                              className="flex-1 px-2 py-1 border border-gray-300 rounded text-sm focus:ring-2 focus:ring-indigo-500 focus:border-transparent outline-none"
                            />
                            <button
                              onClick={handleAddTimeSlot}
                              disabled={!newSlotTime || timeSlots[newSlotTime]}
                              className="px-3 py-1 bg-indigo-600 hover:bg-indigo-700 disabled:bg-gray-400 text-white rounded text-sm font-medium transition-colors"
                            >
                              Add
                            </button>
                          </div>
                        </div>

                        {/* Save Settings Button */}
                        <div className="mb-6 pb-6 border-b border-gray-200">
                          <button
                            onClick={saveSettings}
                            disabled={savingSettings || !settingsLoaded}
                            className="w-full bg-green-600 hover:bg-green-700 disabled:bg-gray-400 text-white font-semibold py-2 rounded text-sm transition-colors"
                          >
                            {savingSettings ? 'Saving...' : 'Save Settings'}
                          </button>
                          <p className="text-xs text-gray-500 mt-2 text-center">Click to save date, time slots, and GDPR text</p>
                        </div>

                        <div>
                          <div className="flex justify-between items-center mb-3">
                            <h3 className="font-semibold text-gray-800 text-sm">Reservations</h3>
                            <button
                              onClick={loadBookings}
                              className="text-xs px-2 py-1 bg-indigo-100 hover:bg-indigo-200 text-indigo-700 rounded"
                            >
                              Refresh
                            </button>
                          </div>
                          {reservations.length === 0 ? (
                            <p className="text-gray-500 text-xs">No reservations yet</p>
                          ) : (
                            <div className="space-y-2 max-h-60 overflow-y-auto">
                              {reservations.map(res => (
                                <div key={res.id} className="bg-indigo-50 border border-indigo-200 rounded p-2 text-xs">
                                  <p className="font-semibold text-gray-800">{res.firstName} {res.lastName}</p>
                                  <p className="text-gray-600">{res.email}</p>
                                  {res.phone && <p className="text-gray-600">{res.phone}</p>}
                                  <div className="flex justify-between items-center mt-1">
                                    <span className="text-gray-700">{res.date} - {res.time}</span>
                                    <button
                                      onClick={() => handleDeleteReservation(res.id)}
                                      className="bg-red-100 hover:bg-red-200 text-red-700 px-2 py-0.5 rounded"
                                    >
                                      Delete
                                    </button>
                                  </div>
                                </div>
                              ))}
                            </div>
                          )}
                        </div>
                      </div>
                    </div>
                  )}
                </div>
              </div>
            </div>
          );
        }

        ReactDOM.render(<AppointmentBooking />, document.getElementById('root'));
    </script>
</body>
</html>
